<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangman Survival!!</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #f4f7f6; margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        /* Ë®àÊôÇÊ¢ùÊ®£Âºè */
        #timer-bar-container { width: 100%; height: 8px; background: #eee; position: absolute; top: 0; left: 0; }
        #timer-bar { width: 100%; height: 100%; background: #3498db; transition: width 1s linear; }
        
        #word-display { font-size: 2.2em; letter-spacing: 0.2em; margin: 20px 0; color: #3498db; font-weight: bold; min-height: 1.5em; }
        #hangman-drawing { font-family: monospace; white-space: pre; background: #333; color: #2ecc71; padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 14px; display: inline-block; line-height: 1.2; }
        .btn { padding: 12px 25px; font-size: 16px; cursor: pointer; border: none; border-radius: 10px; background: #2ecc71; color: white; transition: 0.2s; }
        #keyboard { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 25px; }
        .key { padding: 12px 2px; background: #ecf0f1; border-radius: 8px; cursor: pointer; font-weight: bold; border-bottom: 3px solid #bdc3c7; }
        .key.used { background: #dfe6e9; color: #b2bec3; cursor: not-allowed; border: none; }
        #leaderboard-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #3498db; display: flex; align-items: center; justify-content: center; z-index: 2000; color: white; }
        .info-bar { background: #fdfdfd; padding: 12px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; font-weight: bold; }
        .msg-box { height: 30px; font-weight: bold; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div>
        <h1>Hangman Survival!!</h1>
        <input type="text" id="player-name-input" placeholder="Your Name..."><br><br>
        <button class="btn" onclick="login()" style="background: white; color: #3498db;">Start Survival</button>
    </div>
</div>

<div class="container">
    <div id="timer-bar-container"><div id="timer-bar"></div></div>
    <h1>Hangman Survival!!</h1>
    <div class="info-bar">
        <span>üë§ <span id="display-name">-</span></span>
        <span>‚è±Ô∏è <span id="timer-text">30</span>s</span>
        <span style="color: #e74c3c;">üèÜ Score: <span id="display-score">0</span></span>
    </div>
    
    <div id="hangman-drawing">  +---+ ... </div>

    <div id="hint-display" style="background: #fff9db; padding: 15px; border-radius: 10px; text-align: left; margin-bottom: 20px;">Loading...</div>
    <div id="word-display">_ _ _ _ _</div>
    <div id="status" style="font-size: 1.2em; margin-bottom: 10px;">Lives: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <div id="game-msg" class="msg-box"></div>

    <div id="keyboard"></div>
    <div id="action-area" style="margin-top: 25px;">
        <button class="btn" onclick="skipQuestion()" style="background: #e67e22;">Skip Question (-1 ‚ù§Ô∏è)</button>
    </div>
</div>

<div id="leaderboard-modal">
    <div class="modal-content">
        <h2>üíÄ Game Over</h2>
        <p id="final-summary"></p>
        <div id="leader-list" style="text-align: left; margin: 20px 0;"></div>
        <button class="btn" onclick="location.reload()" style="width: 100%;">Restart</button>
    </div>
</div>

<script>
    let currentWord = "", guessedLetters = [], lives = 6, totalScore = 0, isGameOver = false;
    let timeLeft = 30, timerId = null;

    const stages = [
        `  +---+\n  |   |\n  O   |\n /|\\  |\n / \\  |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n /|\\  |\n /    |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n /|\\  |\n      |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n /|   |\n      |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n  |   |\n      |\n      |\n=========`,
        `  +---+\n  |   |\n  O   |\n      |\n      |\n      |\n=========`,
        `  +---+\n  |   |\n      |\n      |\n      |\n      |\n=========`
    ];

    async function login() {
        const name = document.getElementById('player-name-input').value;
        if (!name) return alert("Enter name!");
        await fetch('/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name: name}) });
        document.getElementById('display-name').innerText = name;
        document.getElementById('login-overlay').style.display = 'none';
        startNewRound();
    }

    function startTimer() {
        clearInterval(timerId);
        timeLeft = 30;
        updateTimerUI();
        timerId = setInterval(() => {
            timeLeft--;
            updateTimerUI();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                handleTimeOut();
            }
        }, 1000);
    }

    function updateTimerUI() {
        document.getElementById('timer-text').innerText = timeLeft;
        document.getElementById('timer-bar').style.width = (timeLeft / 30 * 100) + "%";
        // ÊôÇÈñìÂø´Âà∞ÊôÇËÆäËâ≤
        document.getElementById('timer-bar').style.background = timeLeft < 10 ? "#e74c3c" : "#3498db";
    }

    function handleTimeOut() {
        if (isGameOver) return;
        lives--;
        document.getElementById('game-msg').style.color = "#e67e22";
        document.getElementById('game-msg').innerText = "Time's up! -1 Life";
        if (lives <= 0) updateUI();
        else startNewRound();
    }

    async function startNewRound() {
        if (isGameOver) return;
        const res = await fetch('/get_word');
        const data = await res.json();
        currentWord = data.word;
        document.getElementById('hint-display').innerHTML = "üí° " + data.hint;
        guessedLetters = [];
        document.getElementById('game-msg').innerText = "";
        updateUI();
        createKeyboard();
        startTimer();
    }

    function createKeyboard() {
        const kb = document.getElementById('keyboard');
        kb.innerHTML = "";
        "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach(l => {
            const div = document.createElement('div');
            div.innerText = l; div.className = "key";
            div.onclick = () => {
                if (guessedLetters.includes(l) || isGameOver) return;
                guessedLetters.push(l);
                div.className = "key used";
                if (!currentWord.includes(l)) lives--;
                updateUI();
            };
            kb.appendChild(div);
        });
    }

    function skipQuestion() {
        if (isGameOver) return;
        lives--;
        if (lives <= 0) updateUI();
        else startNewRound();
    }

    function updateUI() {
        let display = "";
        for (let char of currentWord) {
            if (char === " ") display += "&nbsp;&nbsp;";
            else display += guessedLetters.includes(char) ? char : "_ ";
        }
        document.getElementById('word-display').innerHTML = display;
        document.getElementById('status').innerText = "Lives: " + "‚ù§Ô∏è".repeat(Math.max(0, lives));
        document.getElementById('hangman-drawing').innerText = stages[lives] || stages[0];

        if (!display.includes("_") && currentWord !== "" && !isGameOver) {
            clearInterval(timerId); // Á≠îÂ∞çÊôÇÂÅúÊ≠¢Ë®àÊôÇ
            totalScore += 10;
            document.getElementById('display-score').innerText = totalScore;
            document.getElementById('game-msg').style.color = "#2ecc71";
            document.getElementById('game-msg').innerText = "Correct! +10 Points";
            setTimeout(startNewRound, 1000);
        } else if (lives <= 0) {
            gameOver();
        }
    }

    function gameOver() {
        isGameOver = true;
        clearInterval(timerId);
        document.getElementById('word-display').innerHTML = `<span style="color:#e74c3c">${currentWord}</span>`;
        document.getElementById('game-msg').style.color = "#e74c3c";
        document.getElementById('game-msg').innerText = "Survival Over!";
        document.getElementById('keyboard').innerHTML = "";
        document.getElementById('action-area').innerHTML = `<button class="btn" onclick="showLeaderboard()" style="background:#3498db">View Leaderboard</button>`;
    }

    async function showLeaderboard() {
        const res = await fetch('/update_score', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({final_score: totalScore}) });
        const data = await res.json();
        document.getElementById('final-summary').innerHTML = `Final Score: <b>${totalScore}</b>`;
        document.getElementById('leader-list').innerHTML = data.leaderboard.map((p, i) => 
            `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #eee;"><span>${i+1}. ${p.name}</span><span>${p.score} pts</span></div>`).join('');
        document.getElementById('leaderboard-modal').style.display = 'flex';
    }
</script>
</body>
</html>
