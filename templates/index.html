<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival Hangman - B1-C2 Vocabulary</title>
    <style>
        :root { --primary: #00b894; --danger: #ff7675; --bg: #f9f9f9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; color: #2d3436; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%; max-width: 500px; text-align: center; }
        h1 { margin-bottom: 0.5rem; }
        #hangmanCanvas { background: #fff; border-bottom: 2px solid #eee; margin-bottom: 1rem; width: 180px; height: 180px; }
        #sentenceArea { font-size: 1.4rem; letter-spacing: 3px; margin: 20px 0; font-weight: bold; min-height: 1.5em; word-wrap: break-word; }
        #hintText { color: #636e72; font-style: italic; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.4; }
        #livesDisplay { font-size: 1.2rem; margin-bottom: 10px; color: var(--danger); font-weight: bold; }
        
        /* ËôõÊì¨ÈçµÁõ§Ê®£Âºè */
        .keyboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(35px, 1fr)); gap: 5px; margin-top: 20px; }
        .key { padding: 10px 5px; border: none; background: #dfe6e9; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .key:hover { background: #b2bec3; }
        .key:disabled { background: #eee; color: #ccc; cursor: not-allowed; }
        
        button#nextBtn { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-size: 1rem; cursor: pointer; margin-top: 20px; display: none; width: 100%; }
        #winMessage { color: var(--primary); font-weight: bold; margin-top: 10px; height: 1.2em; }
    </style>
</head>
<body>

    <div class="card">
        <h1>Survival Mode</h1>
        <div id="livesDisplay">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <canvas id="hangmanCanvas" width="200" height="200"></canvas>
        <div id="hintText">Connecting to Server...</div>
        <div id="sentenceArea">Loading...</div>
        <div id="winMessage"></div>

        <div class="keyboard" id="kbd"></div>

        <button id="nextBtn" onclick="fetchNewQuestion()">Next Sentence</button>
    </div>

    <script>
        let target = "", full = "", guessed = [], lives = 6, totalWrong = 0, isRoundOver = false;

        async function fetchNewQuestion() {
            try {
                const res = await fetch('/api/get_question');
                const d = await res.json();
                target = d.target.toLowerCase();
                full = d.full_sentence;
                guessed = [];
                isRoundOver = false;
                document.getElementById('hintText').innerText = "üí° HINT: " + d.hint;
                document.getElementById('winMessage').innerText = "";
                document.getElementById('nextBtn').style.display = "none";
                updateKeyboard();
                render();
            } catch (e) {
                document.getElementById('sentenceArea').innerText = "Server Connection Failed";
            }
        }

        function handleInput(char) {
            if (isRoundOver || lives <= 0 || guessed.includes(char)) return;
            guessed.push(char);
            if (!target.includes(char)) {
                lives--;
                totalWrong++;
            }
            checkState();
            updateKeyboard();
            render();
        }

        function checkState() {
            const isWin = target.split('').every(l => guessed.includes(l));
            if (isWin) {
                document.getElementById('winMessage').innerText = "üéâ CORRECT!";
                document.getElementById('nextBtn').style.display = "block";
                isRoundOver = true;
            } else if (lives <= 0) {
                document.getElementById('winMessage').innerText = "üíÄ GAME OVER! Word: " + target.toUpperCase();
                document.getElementById('nextBtn').innerText = "Try Again";
                document.getElementById('nextBtn').style.display = "block";
                document.getElementById('nextBtn').onclick = () => location.reload();
                isRoundOver = true;
            }
        }

        function render() {
            // Ê∏≤ÊüìÂñÆÂ≠ó
            const display = target.split('').map(l => guessed.includes(l) ? l.toUpperCase() : "_").join(" ");
            document.getElementById('sentenceArea').innerText = display;
            
            // Ê∏≤ÊüìÁîüÂëΩ
            document.getElementById('livesDisplay').innerText = "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(6-lives);

            // Áπ™Ë£Ω Hangman
            const ctx = document.getElementById('hangmanCanvas').getContext('2d');
            ctx.clearRect(0, 0, 200, 200);
            ctx.lineWidth = 3;
            ctx.strokeStyle = "#2d3436";
            
            if (lives < 6) { ctx.beginPath(); ctx.arc(100, 50, 20, 0, Math.PI*2); ctx.stroke(); } // È†≠
            if (lives < 5) { ctx.moveTo(100, 70); ctx.lineTo(100, 130); ctx.stroke(); } // Ë∫´È´î
            if (lives < 4) { ctx.moveTo(100, 80); ctx.lineTo(70, 110); ctx.stroke(); } // Â∑¶Êâã
            if (lives < 3) { ctx.moveTo(100, 80); ctx.lineTo(130, 110); ctx.stroke(); } // Âè≥Êâã
            if (lives < 2) { ctx.moveTo(100, 130); ctx.lineTo(70, 170); ctx.stroke(); } // Â∑¶ËÖ≥
            if (lives < 1) { ctx.moveTo(100, 130); ctx.lineTo(130, 170); ctx.stroke(); } // Âè≥ËÖ≥
        }

        function updateKeyboard() {
            const kbd = document.getElementById('kbd');
            kbd.innerHTML = "";
            "abcdefghijklmnopqrstuvwxyz".split("").forEach(l => {
                const btn = document.createElement('button');
                btn.innerText = l.toUpperCase();
                btn.className = "key";
                if (guessed.includes(l)) btn.disabled = true;
                btn.onclick = () => handleInput(l);
                kbd.appendChild(btn);
            });
        }

        window.addEventListener('keydown', e => {
            if(e.key.match(/^[a-z]$/i)) handleInput(e.key.toLowerCase());
        });

        fetchNewQuestion();
    </script>
</body>
</html>